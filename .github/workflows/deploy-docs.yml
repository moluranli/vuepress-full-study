name: Deploy VuePress Site

on:
  push:
    branches:
      - main  # 只在 main 分支推送时触发

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    concurrency: 
      group: deploy-${{ github.ref }}
      cancel-in-progress: true
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # 获取完整提交历史

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm install

    # 创建 VuePress 配置文件（包含禁用 Markdown 严格校验）
    - name: Create VuePress config
      run: |
        mkdir -p docs/.vuepress
        cat > docs/.vuepress/config.js << 'EOF'
        import { defineUserConfig } from 'vuepress'
        import { defaultTheme } from '@vuepress/theme-default'

        export default defineUserConfig({
          lang: 'zh-CN',
          title: 'VuePress 学习文档',
          description: 'VuePress 2.x 完整学习项目',
          
          // 禁用 Markdown 严格模式的核心配置
          markdown: {
            html: true,         // 允许 HTML 标签
            breaks: true,       // 允许换行符转换为 <br>
            linkify: true,      // 自动将 URL 转换为链接
            typographer: true,  // 启用排版增强
          },
          
          // 扩展 markdown-it 配置
          extendsMarkdown: (md) => {
            // 禁用严格的 HTML 块规则
            md.disable('html_block')
            
            // 允许不闭合的 HTML 标签
            md.renderer.rules.html_block = (tokens, idx) => {
              return tokens[idx].content
            }
          },
          
          // 主题配置
          theme: defaultTheme({
            navbar: [
              { text: '首页', link: '/' },
              { text: '指南', link: '/guide/' }
            ],
            sidebar: 'auto'
          }),
          
          // Vite 配置
          bundler: '@vuepress/bundler-vite',
          bundlerConfig: {
            viteOptions: {
              ssr: {
                noExternal: ['vue']
              }
            }
          }
        })
        EOF

    - name: Build VuePress site
      run: npm run docs:build

    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: docs/.vuepress/dist
        force_orphan: true  # 确保每次部署都创建新的提交历史
        user_name: 'github-actions[bot]'
        user_email: 'github-actions[bot]@users.noreply.github.com'